#!/usr/bin/env bash
# Timer script for daily tasks. Used Fuzzel and YAD
# Dependencies: jq, yad, fuzzel, notify-send

# Config
queue="$HOME/.local/share/timers/queue.json"
daemon="$HOME/.local/bin/timer_daemon.sh"

# Icons (Nerd Font md-variants)
icon_new="󰔛"
icon_edit="󰏫"
icon_clear="󰆴"
icon_start="󰐊"
icon_stop="󰅗"

# Helpers
notify() { notify-send -t 2500 "$@"; }
signal_waybar() {
  if pgrep -x "waybar" >/dev/null; then
    pkill -RTMIN+3 waybar 2>/dev/null
  fi
}
# Setup
mkdir -p "$(dirname "$queue")"
[[ ! -f "$queue" ]] && echo "[]" >"$queue"

# Check daemon status
if pgrep -f "$daemon" >/dev/null; then
  daemon_running=true
else
  daemon_running=false
  notify "Timer Daemon Not Running" "Timers will not ring until started"
fi

# Build dynamic menu
menu="$icon_new New Timer\n$icon_edit Edit Timers\n$icon_clear Clear All"
if $daemon_running; then
  menu="$menu\n$icon_stop Stop Daemon"
else
  menu="$menu\n$icon_start Start Daemon"
fi

choice=$(printf "%b" "$menu" | fuzzel --minimal-lines -p "" --dmenu --placeholder "Manage timers")
[[ -z "$choice" ]] && exit 0

# Menu Logic
case "$choice" in
"$icon_new New Timer")
  default_time=$(date +%R)
  default_date_dm=$(date +%d-%m)
  default_year=$(date +%Y)

  yad_out=$(yad --form \
    --title="$icon_new Set New Timer" \
    --width=400 --center \
    --text="Enter time, date, and message." \
    --field="Time (HH:MM):" "$default_time" \
    --field="Date (DD-MM):" "$default_date_dm" \
    --field="Year (YYYY):" "$default_year" \
    --field="Message:" "" \
    --button="Cancel:1" --button="Set Timer:0")

  [[ $? -ne 0 ]] && exit 0
  IFS='|' read -r time_str date_str year_str message <<<"$yad_out"
  [[ -z "$time_str" || -z "$date_str" || -z "$year_str" ]] && exit 0

  target_datetime="$year_str-$(echo "$date_str" | cut -d'-' -f2)-$(echo "$date_str" | cut -d'-' -f1) $time_str"
  fire_at=$(date -d "$target_datetime" +%s 2>/dev/null) || exit 1

  now=$(date +%s)
  if ((fire_at <= now)); then
    fire_at=$(date -d "$target_datetime +1 day" +%s)
    notify "Adjusted" "Timer moved to tomorrow"
  fi

  id=$(date +%s%N)
  new_entry=$(jq -n \
    --arg id "$id" \
    --argjson fire_at "$fire_at" \
    --arg message "$message" \
    '{id: $id, fire_at: $fire_at, message: $message}')

  tmp=$(mktemp)
  jq ". += [$new_entry]" "$queue" >"$tmp" && mv "$tmp" "$queue"

  human=$(date -d "@$fire_at" "+%H:%M on %d-%m-%Y")
  notify "Timer Set" "$message ($human)"
  signal_waybar
  ;;

"$icon_edit Edit Timers")
  timers=$(jq -r '.[] | "\(.id)|\(.fire_at)|\(.message)"' "$queue")
  [[ -z "$timers" ]] && notify "No timers set" && exit 0

  list_tmp=$(mktemp)
  echo "$timers" | while IFS='|' read -r id fire_at message; do
    human=$(date -d "@$fire_at" "+%d-%m %H:%M")
    echo -e "FALSE\n$id\n$human\n$message" >>"$list_tmp"
  done

  selection=$(yad --list \
    --title="$icon_edit Edit Timer" \
    --width=650 --height=350 --center \
    --column="✓":CHK \
    --column="ID":H \
    --column="Date/Time" \
    --column="Message" \
    --multiple --no-markup \
    --button="Edit:0" --button="Delete:10" --button="Close:1" \
    --print-all <"$list_tmp")

  yad_exit=$?
  rm -f "$list_tmp"

  case $yad_exit in
  0) # Edit Timer
    selected_id=$(awk -F'|' '$1=="TRUE"{print $2}' <<<"$selection" | head -n1)
    [[ -z "$selected_id" ]] && notify "Select one timer" && exit 0

    current=$(jq -r ".[] | select(.id==\"$selected_id\")" "$queue")
    fire_at=$(jq -r '.fire_at' <<<"$current")
    message=$(jq -r '.message' <<<"$current")

    time_str=$(date -d "@$fire_at" +%R)
    date_str=$(date -d "@$fire_at" +%d-%m)
    year_str=$(date -d "@$fire_at" +%Y)

    edit_out=$(yad --form \
      --title="$icon_edit Edit Timer" \
      --width=400 --center \
      --field="Time (HH:MM):" "$time_str" \
      --field="Date (DD-MM):" "$date_str" \
      --field="Year (YYYY):" "$year_str" \
      --field="Message:" "$message" \
      --button="Cancel:1" --button="Save:0")

    [[ $? -ne 0 ]] && exit 0
    IFS='|' read -r new_time new_date new_year new_msg <<<"$edit_out"

    new_dt="$new_year-$(echo "$new_date" | cut -d'-' -f2)-$(echo "$new_date" | cut -d'-' -f1) $new_time"
    new_fire_at=$(date -d "$new_dt" +%s 2>/dev/null)
    ((new_fire_at <= $(date +%s))) && notify "Invalid" "Cannot set past time" && exit 1

    tmp=$(mktemp)
    jq "(.[] | select(.id == \"$selected_id\")) |= (.fire_at = $new_fire_at | .message = \"$new_msg\")" "$queue" >"$tmp"
    mv "$tmp" "$queue"

    notify "Timer Updated" "$new_msg"
    signal_waybar
    ;;

  10) # Delete Selected
    ids=$(awk -F'|' '$1=="TRUE"{print $2}' <<<"$selection")
    [[ -z "$ids" ]] && notify "No timers selected" && exit 0

    id_array=$(printf '%s\n' "$ids" | jq -R . | jq -s .)
    tmp=$(mktemp)
    jq --argjson ids "$id_array" '[.[] | select((.id|tostring) as $i | $ids | index($i) | not)]' "$queue" >"$tmp"
    mv "$tmp" "$queue"

    notify "Timers Deleted"
    signal_waybar
    ;;
  esac
  ;;

"$icon_clear Clear All")
  echo "[]" >"$queue"
  notify "All Timers Cleared"
  signal_waybar
  ;;

"$icon_stop Stop Daemon")
  "$daemon" kill
  notify "$icon_stop Daemon Stopped"
  ;;

"$icon_start Start Daemon")
  setsid "$daemon" >/dev/null 2>&1 &
  notify "$icon_start Daemon Started"
  ;;
esac
