#!/usr/bin/env bash

notify="notify-send -t 5000"
menu="fuzzel -d -l 1 -w 35 -p"

# Prompt
input=$($menu "Set time:" --placeholder "(e.g. 5m, 1h, or 13:05)")

# If format is HH:MM (absolute future time)
if [[ "$input" =~ ^([0-9]{1,2}):([0-9]{2})$ ]]; then
  hour=${BASH_REMATCH[1]}
  minute=${BASH_REMATCH[2]}

  target=$(date -d "$(date +%F) $hour:$minute" +%s)
  now=$(date +%s)

  ((target <= now)) && target=$(date -d "tomorrow $hour:$minute" +%s)
  seconds=$((target - now))

# Check relative format N + optional unit (s/m/h)
elif [[ "$input" =~ ^([0-9]+)([smh]?)$ ]]; then
  number="${BASH_REMATCH[1]}"
  unit="${BASH_REMATCH[2]}"

  case "$unit" in
  "" | s) seconds=$((number)) ;;
  m) seconds=$((number * 60)) ;;
  h) seconds=$((number * 3600)) ;;
  *)
    $notify "⏰ Timer Error" "Invalid unit. Allowed: s, m, h or HH:MM"
    exit 1
    ;;
  esac

# Otherwise reject input
else
  $notify "⏰ Timer Error" "Invalid format.\nUse: 5m, 1h, 30s or HH:MM"
  exit 1
fi

# Must be positive seconds
if [ "$seconds" -lt 1 ]; then
  $notify "⏰ Timer Error" "Time must be greater than zero."
  exit 1
fi

# Ask message
message=$($menu "Message:" --placeholder "(e.g. brush your teeth!)")
[ -z "$message" ] && message="⏰ Timer ($input) expired!"

# Short summary after timer is set
h=$((seconds / 3600))
m=$(((seconds % 3600) / 60))
s=$((seconds % 60))

human_time=""
((h > 0)) && human_time+="${h}h "
((m > 0)) && human_time+="${m}m "
((s > 0 && h == 0)) && human_time+="${s}s"

$notify "⏳ Timer set" "Time: $human_time\nMessage: $message"

sleep "$seconds"

# Popup
zenity --info --title="⏰ Timer Finished" --text="$message" --width=250 &
pw-play ~/.local/share/Sounds/complete.oga
