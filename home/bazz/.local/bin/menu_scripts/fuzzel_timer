#!/usr/bin/env bash

notify="notify-send -t 5000"
menu="fuzzel -d -l 3 -w 35 -p"
queue="$HOME/.local/share/timers/queue"

mkdir -p "$(dirname "$queue")"
touch "$queue"

# Human-friendly "time remaining"
format_remaining() {
  local now fire diff
  now=$(date +%s)
  fire="$1"
  diff=$((fire - now))

  if ((diff <= 0)); then
    echo "Expired"
    return
  fi

  local d=$((diff / 86400))
  local h=$(((diff % 86400) / 3600))
  local m=$(((diff % 3600) / 60))
  local s=$((diff % 60))

  local out=""
  ((d > 0)) && out+="${d}d "
  ((h > 0)) && out+="${h}h "
  ((m > 0)) && out+="${m}m "
  ((s > 0 && d == 0 && h == 0)) && out+="${s}s "

  echo "$out"
}

# Manage timers
manage_timers() {

  if [ ! -s "$queue" ]; then
    $notify "‚è∞ Timer Manager" "No timers currently set."
    return 0
  fi

  list_data_tmp=$(mktemp)

  sort -t'|' -k2,2n "$queue" | while IFS="|" read -r id fire_at message; do
    human=$(date -d "@$fire_at" "+%H:%M:%S on %d-%m-%Y")
    remaining=$(format_remaining "$fire_at")
    echo -e "FALSE\n$id\n$human\n$remaining\n$message" >>"$list_data_tmp"
  done

  ACTION=$(
    yad --list \
      --title="Manage Timers" \
      --text="List of Timers" \
      --width=720 --height=350 --center \
      --column="‚úì":CHK \
      --column="ID":H \
      --column="Fire At" \
      --column="Remaining" \
      --column="Message" \
      --button="‚úèÔ∏è Edit:20" \
      --button="üóëÔ∏è Delete:10" \
      --button="Close:1" \
      --multiple \
      --no-markup \
      --search-column=3 \
      --print-all \
      <"$list_data_tmp"
  )

  YAD_EXIT_CODE=$?
  rm -f "$list_data_tmp"

  case $YAD_EXIT_CODE in
  # Delete timers
  10)
    SELECTED_IDS=$(echo "$ACTION" | awk -F"|" '$1=="TRUE"{print $2}')

    if [ -z "$SELECTED_IDS" ]; then
      $notify "No Selection" "No timers selected."
      return 0
    fi

    if yad --question --title="Confirm" --text="Delete selected timers?" --button="No:1" --button="Yes:0"; then
      tmp=$(mktemp)
      while IFS="|" read -r id fire_at message; do
        if ! grep -q "^$id$" <<<"$SELECTED_IDS"; then
          echo "$id|$fire_at|$message" >>"$tmp"
        fi
      done <"$queue"
      mv "$tmp" "$queue"
      $notify "Deleted" "Timers removed."
      manage_timers
    fi
    ;;

  # Edit timer
  20)
    SELECTED_ID=$(echo "$ACTION" | awk -F"|" '$1=="TRUE"{print $2}' | head -n1)

    if [ -z "$SELECTED_ID" ]; then
      $notify "No Selection" "Select a single timer to edit."
      return 0
    fi

    OLD_ENTRY=$(grep "^$SELECTED_ID|" "$queue")
    fire_at=$(echo "$OLD_ENTRY" | cut -d'|' -f2)
    message=$(echo "$OLD_ENTRY" | cut -d'|' -f3-)

    time_str=$(date -d "@$fire_at" +%R)
    date_str=$(date -d "@$fire_at" +%d-%m)
    year_str=$(date -d "@$fire_at" +%Y)

    EDIT_OUTPUT=$(yad --form \
      --title="Edit Timer" \
      --text="Modify timer values:" \
      --width=400 --center \
      --field="Time (HH:MM):" "$time_str" \
      --field="Date (DD-MM):" "$date_str" \
      --field="Year (YYYY):" "$year_str" \
      --field="Message:" "$message" \
      --button="Cancel:1" \
      --button="Save:0")

    [[ $? -ne 0 ]] && return 0

    IFS='|' read -r new_time new_date new_year new_msg <<<"$EDIT_OUTPUT"
    [[ -z "$new_time" || -z "$new_date" || -z "$new_year" ]] && return 0

    target_datetime="$new_year-$(echo "$new_date" | cut -d'-' -f2)-$(echo "$new_date" | cut -d'-' -f1) $new_time"
    new_fire_at=$(date -d "$target_datetime" +%s 2>/dev/null)

    if [ -z "$new_fire_at" ] || ((new_fire_at <= $(date +%s))); then
      $notify "‚ùå Edit Error" "Invalid or past time."
      return 1
    fi

    tmp=$(mktemp)
    while IFS="|" read -r id fa msg; do
      if [[ "$id" == "$SELECTED_ID" ]]; then
        echo "$id|$new_fire_at|$new_msg" >>"$tmp"
      else
        echo "$id|$fa|$msg" >>"$tmp"
      fi
    done <"$queue"
    mv "$tmp" "$queue"

    $notify "‚úèÔ∏è Timer Updated" "Timer modified successfully."
    manage_timers
    ;;
  *) return 0 ;;
  esac
}

# Menu
choice=$(
  $menu "> " <<EOF
‚è∞ Set timer
üóíÔ∏è Show timers
EOF
)

[ -z "$choice" ] && exit 0

if [[ "$choice" == *"Show timers" ]]; then
  manage_timers
  exit 0
fi

# Set new timer
if [[ "$choice" == *"Set timer" ]]; then

  if ! pgrep -f "timer_daemon.sh" >/dev/null; then
    $notify "‚è∞ Timer Daemon Not Running" "Timers will not ring."
  fi

  default_time=$(date +%R)
  default_date_dm=$(date +%d-%m)
  default_year=$(date +%Y)

  read -r -d '' YAD_CMD <<EOF
yad --form \
  --title="Set New Timer" \
  --text="Enter time, date, year, and message." \
  --width=400 --center \
  --field="Time (HH:MM):" "$default_time" \
  --field="Date (DD-MM):" "$default_date_dm" \
  --field="Year (YYYY):" "$default_year" \
  --field="Message:" "" \
  --button="Cancel:1" \
  --button="Set Timer:0"
EOF

  IFS='|' read -r time_input date_dm_input year_input message_input <<<"$(eval "$YAD_CMD")"
  YAD_EXIT_CODE=$?

  [[ $YAD_EXIT_CODE -ne 0 ]] && exit 0
  [[ -z "$time_input" || -z "$date_dm_input" || -z "$year_input" ]] && exit 0

  target_datetime="$year_input-$(echo "$date_dm_input" | cut -d'-' -f2)-$(echo "$date_dm_input" | cut -d'-' -f1) $time_input"
  fire_at=$(date -d "$target_datetime" +%s 2>/dev/null)

  if [ -z "$fire_at" ]; then
    $notify "‚ùå Timer Error" "Invalid date/time."
    exit 1
  fi

  now=$(date +%s)
  if ((fire_at <= now)); then
    next_day_fire_at=$(date -d "$target_datetime + 1 day" +%s 2>/dev/null)
    if ((next_day_fire_at > now)); then
      fire_at="$next_day_fire_at"
      $notify "Time Rolled" "Time was past ‚Äî set for tomorrow."
    else
      $notify "‚ùå Timer Error" "Still invalid."
      exit 1
    fi
  fi

  [[ -z "$message_input" ]] && message_input="‚è∞ Timer expired!"

  id=$(date +%s%N)
  echo "$id|$fire_at|$message_input" >>"$queue"

  human=$(date -d "@$fire_at" "+%H:%M on %d-%m-%Y")
  $notify "Added Timer" "$message_input @ $human"
fi
