#!/usr/bin/env bash

# Prompt
input=$(fuzzel -d -l 1 -w 30 -p "Set time:" --placeholder "(e.g. 5m, 1h, or 13:05)")

# If format is HH:MM (absolute time)
if [[ "$input" =~ ^([0-9]{1,2}):([0-9]{2})$ ]]; then
  hour=${BASH_REMATCH[1]}
  minute=${BASH_REMATCH[2]}

  target=$(date -d "$(date +%F) $hour:$minute" +%s)
  now=$(date +%s)

  ((target <= now)) && target=$(date -d "tomorrow $hour:$minute" +%s)
  seconds=$((target - now))
else
  number=${input%[smh]}
  unit=${input#"$number"}

  case "$unit" in
  s | "") seconds=$((number)) ;;
  m) seconds=$((number * 60)) ;;
  h) seconds=$((number * 3600)) ;;
  *)
    notify-send "⏰ Timer Error" "Use s, m, h or HH:MM"
    exit 1
    ;;
  esac
fi

if [ "$seconds" -ge 1 ]; then
  message=$(fuzzel -d -l 1 -w 35 -p "Message:" --placeholder "(e.g. brush your teeth!)")
  [ -z "$message" ] && message="⏰ Timer ($input) expired!"

  # Short summary after timer is set
  h=$((seconds / 3600))
  m=$(((seconds % 3600) / 60))
  s=$((seconds % 60))

  # Format readable duration
  human_time=""
  ((h > 0)) && human_time+="${h}h "
  ((m > 0)) && human_time+="${m}m "
  ((s > 0 && h == 0)) && human_time+="${s}s"

  notify-send "⏳ Timer Set" "Time: $human_time\nMessage: $message"

  sleep "$seconds"

  # Popup when finished
  zenity --info --title="⏰ Timer Finished" --text="$message" --width=250 &
  pw-play .local/share/Sounds/complete.oga

else
  exit 2
fi
