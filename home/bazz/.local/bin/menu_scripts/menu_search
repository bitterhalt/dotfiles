#!/usr/bin/env bash

# Litle script to search from internet
# Usage: just type and press enter to search from google
# Or specify search engine with letter <a> archwiki <b> brave <d> duckduckgo <y> youtube <w> wikipedia
# example: "a pipewire" opens pipewire section from archwiki

history_file="$HOME/.cache/search_history"
[ -f "$history_file" ] || touch "$history_file"

# Browser
browser="$BROWSER"

# Search engines
web_search="https://www.google.com/search?q="
declare -A engines=(
  [a]="https://wiki.archlinux.org/title/"
  [b]="https://search.brave.com/search?q="
  [d]="https://duckduckgo.com/?q="
  [w]="https://en.wikipedia.org/w/index.php?search="
  [y]="https://www.youtube.com/results?search_query="
)

# URL encode
urlencode() {
  local LC_ALL=C
  local length="${#1}"
  for ((i = 0; i < length; i++)); do
    local c="${1:i:1}"
    case $c in
    [a-zA-Z0-9.~_-]) printf '%s' "$c" ;;
    ' ') printf '+' ;;
    *) printf '%%%02X' "'$c" ;;
    esac
  done
}

# Prompt
keyword=$(cat "$history_file" | fuzzel -d -p "" -l 5 --placeholder "Search from internet...")

# Handle empty input
[ -z "$keyword" ] && exit 0

# Handle history
if ! head -n1 "$history_file" | grep -Fxq "$keyword"; then
  # Remove duplicates, then put new search at the top
  grep -Fxv "$keyword" "$history_file" >"${history_file}.tmp"
  printf '%s\n' "$keyword" >"$history_file"
  cat "${history_file}.tmp" >>"$history_file"
  rm -f "${history_file}.tmp"
fi

search_engine="${keyword%% *}"
search_word="${keyword#* }"

# Open in browser
if [[ -n "${engines[$search_engine]}" && "$search_word" != "$keyword" ]]; then
  "$browser" "${engines[$search_engine]}$(urlencode "$search_word")"
else
  "$browser" "${web_search}$(urlencode "$keyword")"
fi
