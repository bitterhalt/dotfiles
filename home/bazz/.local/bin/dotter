#!/usr/bin/env bash
# Stolen from: https://codeberg.org/jorisvandijk/dotfiles-hyprland/src/branch/main/home/joris/.local/bin/Dotfiles

# Locations
dotfiles_repo=~/Documents/projects/dotfiles
dotfiles_list=~/.local/share/dotlist
exclude_path="$HOME/.local/bin/personal"

# Add new dotfiles
add() {
  echo "[*] Adding dotfiles from list..."
  cd "$dotfiles_repo" || {
    echo "Failed to change directory to $dotfiles_repo"
    exit 1
  }

  # Capture pacman package list once
  pacman -Qe | awk '{print $1}' >"$dotfiles_repo/packages" || echo "Warning: Could not update pacman package list."

  echo "[*] Syncing files (including deletions, excluding $exclude_path)..."
  while IFS= read -r dotfile; do
    if [[ -e "$dotfile" ]]; then
      if rsync -a --relative --delete --exclude "$exclude_path" "$dotfile" "$dotfiles_repo"/; then
        echo "Synced: $dotfile"
      else
        echo "Failed to sync: $dotfile"
      fi
    else
      echo "Missing locally, ensuring deletion in repo: $dotfile"
      # Compute relative path and delete it from repo if it exists
      rel_path=$(realpath --relative-to=/ "$dotfile")
      find "$dotfiles_repo" -path "*/$rel_path" -exec rm -rf {} \; 2>/dev/null
    fi
  done <"$dotfiles_list"

  git add -A
  if [[ -n $(git status -s) ]]; then
    git status
    read -rp "Enter a commit message: " commit_message
    git commit -m "$commit_message"
  else
    echo "No changes to commit."
  fi
}

# Push changes
push() {
  echo "Pushing to repository..."
  cd "$dotfiles_repo" || {
    echo "Failed to change directory to $dotfiles_repo"
    exit 1
  }

  git push && echo "Push complete." || echo "Push failed."
}

# Entry
case "$1" in
add)
  add
  ;;
push)
  push
  ;;
*)
  echo "Usage: $0 {add|push}"
  exit 1
  ;;
esac
