#!/usr/bin/env bash

# CPU
cpu_val=$(top -bn1 | awk -F'load average:' '/load average/ {printf "%.2f", $2}')
cpu="CPU    $cpu_val"

# MEMORY
mem_val=$(free -m | awk 'NR==2{printf "%.2f/%.2fGB", $3/1024, $2/1024}')
mem="MEM    $mem_val"

# UPTIME
upt_val=$(uptime --pretty | sed -e 's/up //g' \
  -e 's/ day[s]*/d/g' \
  -e 's/ hour[s]*/h/g' \
  -e 's/ minute[s]*/m/g' \
  -e 's/,//g')
upt="UP     $upt_val"

# BATTERY
battery=""
for dev in /sys/class/power_supply/*; do
  [ -d "$dev" ] || continue
  case "$(basename "$dev")" in
  BAT* | bat*) battery="$dev" && break ;;
  esac
done

if [ -n "$battery" ]; then
  bat_percent=$(cat "$battery/capacity" 2>/dev/null)
  bat_state=$(cat "$battery/status" 2>/dev/null)
  bat="BAT    ${bat_percent}% (${bat_state})"
else
  bat="BAT    n/a"
fi

# NETWORK
if nmcli -t -f NAME,DEVICE connection show --active >/dev/null 2>&1; then
  active_conn=$(nmcli -t -f NAME,DEVICE connection show --active | head -n1)
  conn_name="${active_conn%%:*}"
  device_name="${active_conn##*:}"

  if [ -z "$conn_name" ]; then
    net="NET    offline"
  else
    if [[ "$device_name" =~ ^wl ]]; then
      wifi_strength=$(nmcli -t -f IN-USE,SSID,SIGNAL dev wifi | awk -F: '/^\*/ {print $3}')
      if [ -n "$wifi_strength" ]; then
        net="NET    (WiFi) $conn_name ${wifi_strength}%"
      else
        net="NET    (WiFi) $conn_name"
      fi
    elif [[ "$device_name" =~ ^en ]]; then
      net="NET    (ETH) $conn_name"
    else
      net="NET    $conn_name"
    fi
  fi
else
  net="NET    offline"
fi

body=$(printf "%s\n%s\n%s\n%s\n%s\n" \
  "$cpu" \
  "$mem" \
  "$net" \
  "$bat" \
  "$upt")

notify-send -t 10000 "System Status" "$body"
